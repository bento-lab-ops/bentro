=== RUN   TestRegister
[GIN] 2026/01/14 - 07:33:41 | 201 |     57.0329ms |                 | POST     "/register"

2026/01/14 07:33:41 [31;1mC:/Users/danbn/.gemini/antigravity/scratch/retro-app/internal/handlers/auth_handler.go:69 [35;1mconstraint failed: UNIQUE constraint failed: users.email (2067)
[0m[33m[1.000ms] [34;1m[rows:0][0m INSERT INTO `users` (`id`,`email`,`display_name`,`password_hash`,`name`,`avatar_url`,`role`,`require_password_change`,`last_login`,`created_at`,`updated_at`) VALUES ("909baaa3-0b99-48c5-b45c-b7a6992210af","john@example.com","johndoe","$2a$10$XzScR28a5iPN0U.FSjEi5etlKN3mEMEUGnJ/0OXFRz.YIpa3Opg8O","John Doe","","user",false,"2026-01-14 07:33:41.08","2026-01-14 07:33:41.081","2026-01-14 07:33:41.081")
[GIN] 2026/01/14 - 07:33:41 | 409 |     56.3446ms |                 | POST     "/register"
--- PASS: TestRegister (0.12s)
=== RUN   TestLogin
[GIN] 2026/01/14 - 07:33:41 | 200 |     58.5511ms |                 | POST     "/login"
[GIN] 2026/01/14 - 07:33:41 | 401 |     53.8394ms |                 | POST     "/login"
--- PASS: TestLogin (0.17s)
=== RUN   TestAuthMiddleware
AuthMiddleware: No token found
[GIN] 2026/01/14 - 07:33:41 | 401 |            0s |                 | GET      "/me"
[GIN] 2026/01/14 - 07:33:41 | 200 |     54.1298ms |                 | POST     "/login"
AuthMiddleware: Setting user_role to: user for user: me@test.com
[GIN] 2026/01/14 - 07:33:41 | 200 |            0s |                 | GET      "/me"
--- PASS: TestAuthMiddleware (0.11s)
=== RUN   TestAdminMiddleware
[GIN] 2026/01/14 - 07:33:41 | 200 |     56.3681ms |                 | POST     "/login"
AuthMiddleware: Setting user_role to: user for user: user@test.com
AdminMiddleware - role exists: true, role value: user
[GIN] 2026/01/14 - 07:33:41 | 403 |       778.1Âµs |                 | GET      "/admin/users"
[GIN] 2026/01/14 - 07:33:41 | 200 |     51.6686ms |                 | POST     "/login"
AuthMiddleware: Setting user_role to: admin for user: admin@test.com
AdminMiddleware - role exists: true, role value: admin
[GIN] 2026/01/14 - 07:33:41 | 200 |            0s |                 | GET      "/admin/users"
--- PASS: TestAdminMiddleware (0.17s)
=== RUN   TestUpdateProfile
[GIN] 2026/01/14 - 07:33:41 | 200 |     59.5515ms |                 | POST     "/login"
AuthMiddleware: Setting user_role to: user for user: u@t.com

2026/01/14 07:33:41 [31;1mC:/Users/danbn/.gemini/antigravity/scratch/retro-app/internal/handlers/auth_handler.go:213 [35;1mrecord not found
[0m[33m[0.000ms] [34;1m[rows:0][0m SELECT * FROM `users` WHERE display_name = "newname" AND id != "7f322136-23ef-4ab9-afc1-5cc731d42323" ORDER BY `users`.`id` LIMIT 1
[GIN] 2026/01/14 - 07:33:41 | 200 |            0s |                 | PUT      "/profile"
AuthMiddleware: Setting user_role to: user for user: u@t.com
[GIN] 2026/01/14 - 07:33:41 | 409 |            0s |                 | PUT      "/profile"
--- PASS: TestUpdateProfile (0.11s)
=== RUN   TestChangePassword
[GIN] 2026/01/14 - 07:33:41 | 200 |     49.9712ms |                 | POST     "/login"
AuthMiddleware: Setting user_role to: user for user: cp@t.com
[GIN] 2026/01/14 - 07:33:41 | 401 |     48.5079ms |                 | POST     "/change-password"
AuthMiddleware: Setting user_role to: user for user: cp@t.com
[GIN] 2026/01/14 - 07:33:41 | 200 |    108.2104ms |                 | POST     "/change-password"
[GIN] 2026/01/14 - 07:33:41 | 200 |     47.0968ms |                 | POST     "/login"
--- PASS: TestChangePassword (0.32s)
=== RUN   TestAdminUserManagement
[GIN] 2026/01/14 - 07:33:42 | 200 |     46.6082ms |                 | POST     "/login"
AuthMiddleware: Setting user_role to: admin for user: adm@t.com
AdminMiddleware - role exists: true, role value: admin
[GIN] 2026/01/14 - 07:33:42 | 200 |       484.1Âµs |                 | PUT      "/admin/users/44f05fa3-187d-4f55-8ae6-6395faf1507f/role"
AuthMiddleware: Setting user_role to: admin for user: adm@t.com
AdminMiddleware - role exists: true, role value: admin
[GIN] 2026/01/14 - 07:33:42 | 200 |     57.1998ms |                 | POST     "/admin/users/44f05fa3-187d-4f55-8ae6-6395faf1507f/reset-password"
AuthMiddleware: Setting user_role to: admin for user: adm@t.com
AdminMiddleware - role exists: true, role value: admin
[GIN] 2026/01/14 - 07:33:42 | 200 |            0s |                 | DELETE   "/admin/users/44f05fa3-187d-4f55-8ae6-6395faf1507f"

2026/01/14 07:33:42 [31;1mC:/Users/danbn/.gemini/antigravity/scratch/retro-app/internal/handlers/auth_handler_test.go:332 [35;1mrecord not found
[0m[33m[0.000ms] [34;1m[rows:0][0m SELECT * FROM `users` WHERE id = "44f05fa3-187d-4f55-8ae6-6395faf1507f" AND `users`.`id` = "44f05fa3-187d-4f55-8ae6-6395faf1507f" ORDER BY `users`.`id` LIMIT 1
--- PASS: TestAdminUserManagement (0.15s)
=== RUN   TestLogout
[GIN] 2026/01/14 - 07:33:42 | 200 |            0s |                 | POST     "/logout"
--- PASS: TestLogout (0.00s)
=== RUN   TestEnsureAdminUser_CreateNew

2026/01/14 07:33:42 [31;1mC:/Users/danbn/.gemini/antigravity/scratch/retro-app/internal/handlers/init_admin.go:17 [35;1mrecord not found
[0m[33m[0.000ms] [34;1m[rows:0][0m SELECT * FROM `users` WHERE email = "admin@system.local" ORDER BY `users`.`id` LIMIT 1
âš  ADMIN_PASSWORD not set, using default: bentro
âœ“ Admin user created successfully (email: admin@system.local)
--- PASS: TestEnsureAdminUser_CreateNew (0.09s)
=== RUN   TestEnsureAdminUser_AlreadyExists
âœ“ Admin user already exists
--- PASS: TestEnsureAdminUser_AlreadyExists (0.10s)
=== RUN   TestEnsureAdminUser_CustomPassword

2026/01/14 07:33:42 [31;1mC:/Users/danbn/.gemini/antigravity/scratch/retro-app/internal/handlers/init_admin.go:17 [35;1mrecord not found
[0m[33m[0.000ms] [34;1m[rows:0][0m SELECT * FROM `users` WHERE email = "admin@system.local" ORDER BY `users`.`id` LIMIT 1
âœ“ Admin user created successfully (email: admin@system.local)
--- PASS: TestEnsureAdminUser_CustomPassword (0.10s)
PASS
ok  	retro-app/internal/handlers	(cached)
